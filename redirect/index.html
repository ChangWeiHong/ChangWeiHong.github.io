<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Redirects — This Repo</title>
  <meta name="description" content="Auto-list folders under the current path and give redirect buttons." />
  <style>
    :root {
      --bg: #0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#60a5fa; --danger:#ef4444;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: var(--bg); color: var(--text); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    h1 { font-size: 20px; margin: 0; font-weight: 650; }
    .path { color: var(--muted); font-size: 12px; word-break: break-all; }
    .card { background: var(--card); border: 1px solid #1f2937; border-radius: 14px; padding: 16px; box-shadow: 0 10px 24px rgba(0,0,0,.25); }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap: 12px; }
    button.link { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid #334155; background: #111827; color: var(--text); cursor: pointer; text-align:left; display:flex; align-items:center; justify-content:space-between; }
    button.link:hover { border-color: var(--accent); outline: 0; }
    .name { font-weight: 600; }
    .arrow { opacity: .7; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; }
    input[type="text"]{ background:#0b1220; color:var(--text); border:1px solid #334155; padding:10px 12px; border-radius:10px; min-width:260px; }
    .pill { font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #334155; color:var(--muted); background:#111827 }
    .err { color: var(--danger); font-size: 13px; margin-top: 10px; }
    footer { margin-top: 18px; color: var(--muted); font-size: 12px; }
    .small { font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Local Redirects</h1>
        <div class="path" id="ctx"></div>
      </div>
      <div class="controls">
        <input id="filter" type="text" placeholder="Filter folders…" />
        <span class="pill" id="branch-pill" title="Resolved branch">branch: …</span>
      </div>
    </header>

    <div class="card" style="margin-top:14px">
      <div id="list" class="grid" aria-live="polite"></div>
      <div id="error" class="err" hidden></div>
      <div class="small" id="hint" style="margin-top:10px"></div>
    </div>

    <footer>
      <p>Excludes: <code>.git</code>, <code>css</code>, <code>img</code>, <code>js</code>, <code>lib</code>, <code>mail</code>, hidden folders, and non-directories. Links go to <code>current path + /folder</code>.</p>
    </footer>
  </div>

<script>
(function(){
  const EXCLUDES = new Set([".git","css","img","js","lib","mail"]);
  const ctxEl = document.getElementById('ctx');
  const listEl = document.getElementById('list');
  const errorEl = document.getElementById('error');
  const hintEl = document.getElementById('hint');
  const filterEl = document.getElementById('filter');
  const branchPill = document.getElementById('branch-pill');

  const u = new URL(window.location.href);
  const host = u.host; // e.g. changweihong.github.io
  const owner = host.split('.')[0];
  const path = u.pathname.replace(/\/+$/, ''); // strip trailing slash
  const segments = path.split('/').filter(Boolean);

  const defaultProjectSubpath = segments.slice(1).join('/');
  const defaultUserRepo = `${owner}/${owner}.github.io`;
  const defaultUserSubpath = segments.join('/');

  // Optional override: ?repo=owner/repo&path=sub/dir&branch=main
  const qpRepo = u.searchParams.get('repo');
  const qpPath = u.searchParams.get('path');
  const qpBranch = u.searchParams.get('branch');
  const pathOverride = qpPath !== null ? qpPath : null;

  const repoCandidates = [];
  const seenCandidate = new Set();
  function addCandidate(repoName, fallbackSubpath){
    const subpathValue = pathOverride !== null ? pathOverride : fallbackSubpath;
    const key = `${repoName}|${subpathValue}`;
    if(seenCandidate.has(key)) return;
    seenCandidate.add(key);
    repoCandidates.push({ repo: repoName, subpath: subpathValue });
  }

  if(qpRepo){
    const fallback = segments.length > 0 ? defaultProjectSubpath : '';
    addCandidate(qpRepo, fallback);
  } else if(segments.length === 0){
    addCandidate(defaultUserRepo, '');
  } else {
    addCandidate(`${owner}/${segments[0]}`, defaultProjectSubpath);
    addCandidate(defaultUserRepo, defaultUserSubpath);
  }

  const basePath = path; // e.g. /my-linktree
  function setContextDisplay(repoName, subpathValue){
    ctxEl.textContent = `${repoName} / ${subpathValue || '(root)'} → ${basePath || '/'}/*`;
  }

  if(repoCandidates.length === 0){
    addCandidate(defaultUserRepo, pathOverride !== null ? pathOverride : '');
  }
  setContextDisplay(repoCandidates[0].repo, repoCandidates[0].subpath);

  const tryBranches = qpBranch ? [qpBranch] : ["gh-pages","main","master"];

  function encodeSubpath(p){
    if(!p) return '';
    return p.split('/').map(encodeURIComponent).join('/');
  }

  async function fetchDir(repoName, subpathValue, branch){
    const subpathPart = subpathValue ? `/${encodeSubpath(subpathValue)}` : '';
    const query = branch ? `?ref=${encodeURIComponent(branch)}` : '';
    const api = `https://api.github.com/repos/${repoName}/contents${subpathPart}${query}`;
    const res = await fetch(api, { headers: { 'Accept':'application/vnd.github+json' } });
    if(!res.ok) {
      const text = await res.text();
      throw new Error(`${res.status} ${res.statusText}: ${text}`);
    }
    return res.json();
  }

  function render(items){
    listEl.innerHTML = '';
    const filter = filterEl.value.trim().toLowerCase();
    const dirs = items
      .filter(x => x.type === 'dir' && !x.name.startsWith('.') && !EXCLUDES.has(x.name))
      .filter(x => !filter || x.name.toLowerCase().includes(filter));

    if(dirs.length === 0){
      listEl.innerHTML = '<div class="small">No folders here. Try another path or branch.</div>';
      return;
    }

    for(const d of dirs){
      const btn = document.createElement('button');
      btn.className = 'link';
      const target = `${basePath || ''}/${d.name}/`.replace(/\/+/, '/');
      btn.onclick = () => location.href = target;
      btn.innerHTML = `<span class="name">${d.name}</span><span class="arrow">→</span>`;
      listEl.appendChild(btn);
    }
  }

  async function init(){
    errorEl.hidden = true; errorEl.textContent = '';
    hintEl.textContent = '';

    let lastErr;
    for(const candidate of repoCandidates){
      setContextDisplay(candidate.repo, candidate.subpath);
      for(const b of tryBranches){
        try {
          const data = await fetchDir(candidate.repo, candidate.subpath, b);
          branchPill.textContent = `branch: ${b}`;
          setContextDisplay(candidate.repo, candidate.subpath);
          render(data);
          hintEl.textContent = `Tip: override with ?repo=owner/repo&path=sub/dir&branch=${b}`;
          return;
        } catch(e){
          lastErr = e;
        }
      }
    }
    branchPill.textContent = 'branch: ?';
    errorEl.hidden = false;
    errorEl.textContent = `Could not list with branches ${tryBranches.join(', ')}. ${lastErr ? lastErr.message : ''}`;
    hintEl.textContent = 'If your Pages uses a different branch, add ?branch=<your-branch>. You can also specify ?repo=owner/repo and ?path=sub/dir.';
  }

  filterEl.addEventListener('input', () => {
    // re-render by refetching current successful branch listing in memory would be nicer,
    // but for simplicity, store last items on window.
  });

  // Keep the last fetched items for filtering without refetch
  let lastItems = [];
  const _render = render;
  render = function(items){ lastItems = items; _render(items); };
  filterEl.addEventListener('input', () => _render(lastItems));

  init();
})();
</script>
</body>
</html>
